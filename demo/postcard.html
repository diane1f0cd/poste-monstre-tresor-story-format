<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8">
		<title>poste monstre tresor prototype</title>
	</head>
	<body>
        <h1>poste monstre tresor prototype</h1>
		<tw-storydata name="poste monstre tresor prototype" startnode="1" creator="Twine" creator-version="2.3.9" ifid="1AAACB08-B51F-45B6-847E-A598DD7ED599" zoom="1" format="Poste-Monstre-Tresor" format-version="0.0.1" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css"></style><script role="script" id="twine-user-script" type="text/twine-javascript"></script><tw-tag name="ATHLETICS" color="purple"></tw-tag>,<tw-tag name="LUCK" color="green"></tw-tag>,<tw-tag name="PERCEPTION" color="blue"></tw-tag>,<tw-tag name="WRECK" color="yellow"></tw-tag><tw-passagedata pid="1" name="0 start" tags="" position="373,575" size="100,100">You are diving into the Depths.
Read the postcard to learn about the Ship, the Treasure and the Beast.
When you&#39;re ready, go to [[2 depths]].</tw-passagedata><tw-passagedata pid="2" name="3 cave ominous" tags="PERCEPTION" position="986,1091" size="100,100">Something feels off. You wonder if the Beast could be at the end of this tunnel.
Count your PERCEPTION.
On a 3 or less, shrug it off and go to [[2 beast]].
Otherwise, you follow your instinct and pick the other path, go to [[4 cave exit]].</tw-passagedata><tw-passagedata pid="3" name="2 depths" tags="" position="502,573" size="100,100">The light barely reaches this place and the currents push you around as you descend. You spot a crevice directly below you.
You have to choose an approach, or risk getting lost.
If you go towards the crevice, go to [[2 crevice]].
If you let the currents carry you, go to [[2 currents]].</tw-passagedata><tw-passagedata pid="4" name="4 cave exit" tags="" position="1083,916" size="100,100">The cave opens up to a wide underwater crater.
In the distance, straight ahead, you recognize a familiar shape.
Go to [[3 sunken ship]].</tw-passagedata><tw-passagedata pid="5" name="2 beast" tags="" position="1349,1071" size="100,100">You were told about The Beast.
You did not listen.
Go to [[9 perish]].</tw-passagedata><tw-passagedata pid="6" name="3 sunken ship" tags="WRECK" position="1406,698" size="100,100">It is the Ship. You approach and enter through the breached hull.
After long minutes scouring through the remains, you spot the Treasure stuck under the remains of this part of the Ship.
Count your WRECK. On a 5 or more, you swiftly retrieve it, go to [[9 finish]]. Otherwise, you struggle to get it unstuck. In the agitation, go to [[2 lurking shadow]].</tw-passagedata><tw-passagedata pid="7" name="2 lurking shadow" tags="" position="1476,864" size="100,100">The Treasure finally comes free, but your ruckus seems to have attracted something.
You feel a presence.
Face it by going to [[4 face the shadow]], or leave immediately by going to [[9 finish]].
</tw-passagedata><tw-passagedata pid="8" name="9 finish" tags="" position="1702,701" size="100,100">You hold the Treasure tightly as you make your way to the surface, leaving the Ship, the Beast and the Depths behind. 
Your adventure ends here.</tw-passagedata><tw-passagedata pid="9" name="9 perish" tags="" position="1521,1116" size="100,100">The Depths were unkind to you. Your adventure ends here.</tw-passagedata><tw-passagedata pid="10" name="2 crevice" tags="" position="527,810" size="100,100">As you enter the crevice, the currents fizzle out and you can move freely.
If you want to go deeper, go to [[2 cave]].
Or you can follow along the crevice, go to [[1 lost in the depths]].</tw-passagedata><tw-passagedata pid="11" name="2 currents" tags="LUCK" position="734,516" size="100,100">You stop moving and let the currents carry you forward.
You have lost control and can only hope you&#39;ll be brought to the right place.
Count your LUCK.
On a 2 or less, go to [[1 cave pull]]; on a 6 or more, go to [[2 ship graveyard safe]]; otherwise, go to [[1 lost in the depths]].</tw-passagedata><tw-passagedata pid="12" name="1 cave pull" tags="" position="821,774" size="100,100">You are pulled through an opening in the rock. Go to [[2 cave]].</tw-passagedata><tw-passagedata pid="13" name="2 ship graveyard safe" tags="" position="945,450" size="100,100">You are calmly led towards the bottom, over a rocky chain, and into a crater.
Go to [[4 ship graveyard]].</tw-passagedata><tw-passagedata pid="14" name="1 lost in the depths" tags="ATHLETICS" position="917,593" size="100,100">You don&#39;t know how far you&#39;ve travelled.
You have clearly gone off course, you need to go back, probably against the current.
Count your ATHLETICS. On a 4 or less, go to [[2 cave]]. Otherwise, you fight the current and reach the bottom at your diving point, go to [[4 ship graveyard]].</tw-passagedata><tw-passagedata pid="15" name="2 cave" tags="WRECK" position="908,900" size="100,100">You find yourself in a maze-like tunnel, with side paths branching off in every direction.
You cross off the paths that are too narrow, the loopbacks and the dead-ends. Two openings remains: one towards a deeper darker cave, and a wide one that&#39;s partially blocked with debris.
Count your WRECK. On a 4 or more, you can easily clear a path through the debris. Go to [[4 cave exit]]. If you don&#39;t think it&#39;s worth the effort, go to [[3 cave ominous]] instead.</tw-passagedata><tw-passagedata pid="16" name="4 ship graveyard" tags="PERCEPTION" position="1194,527" size="100,100">Judging by the ominous piles of debris all around you, a lot of things seem to have sunk and arrived down here.
You hope you did not land too far from the Ship.
Count your PERCEPTION.
On a 4 or less, you spot a dark silhouette that seems to be vaguely shaped like your Ship, go to [[3 distant shape]].
On a 5 or more, the nearby pile of debris feels familiar to you, go to [[3 sunken ship]].</tw-passagedata><tw-passagedata pid="17" name="3 distant shape" tags="LUCK" position="1086,714" size="100,100">The closer you get, the more you realize this is not your Ship at all.
Count your LUCK.
On a 4 or more, it is a dark cave carved into the rocks, enter and go to [[2 cave]]. On a 3 or less, it is something far, far worse. Go to [[2 beast]].</tw-passagedata><tw-passagedata pid="18" name="4 face the shadow" tags="ATHLETICS" position="1621,964" size="100,100">It is, without a doubt, the Beast.
You will later tell the tale you want: that the Beast chased you, or that you chased the Beast, or that both of you let the other go out of respect, or kindness, or fear.
But in truth, you flee. Count your ATHLETICS. On a 4 or more, you will get to tell that story, go to [[9 finish]]. Otherwise, you most certainly won&#39;t, go to [[2 beast]].</tw-passagedata></tw-storydata>
		<script>            
            //HTML passagedata element to JSON object
            parsePassage = function(p) {
                const pid = parseInt(p.getAttribute("pid"), 10);
                const name = p.getAttribute("name");
                const text = p.innerText;

                let links = text.match(/\[\[[^\[\]]+\]\]/g) || [];
                links = links.map(rawLink => {
                    let split = rawLink
                    .replace("[[", "")
                    .replace("]]", "")
                    .split("|");

                    return {
                        "rawText" : rawLink,                        
                        "text" : split[0],
                        "destination" : split[1] || split[0]
                    }
                });

                return { pid, name, text, links };
            }

            //JSON object to formatted text
            renderPassage = function(p) {
                //Number followed by text
                let rendered = "<b>￭"+p.number+": </b>"+p.text;
                //Remove newlines
                rendered = rendered.replace(/\n/g, " ");
                //Consolidate the links
                p.links.forEach( link => {
                    let destPassage = passages.find(pp => pp.name == link.destination);
                    if(link.text == link.destination)
                    {
                        //[[some passage name]] becomes "N"
                        rendered = rendered.replace(link.rawText, destPassage.number);
                    } else 
                    {
                        //[[go to|some passage name]] becomes "go to N"
                        rendered = rendered.replace(link.rawText, "<b>"+link.text.trim()+" "+destPassage.number+"</b>");
                    }                    
                })
                //Remove trailing spaces
                return rendered.trim(); 
            }

            let passages = [...document.querySelectorAll('tw-passagedata')];
            //Parse the passages
            passages = passages.map( p => parsePassage(p) );
            //Sort them alphabetically according to their title
            // (Use numbers at the beginning of passage titles to give the story a general structure)
            passages.sort(function(a, b){
                if(a.name < b.name) { return -1; }
                if(a.name > b.name) { return 1; }
                return 0;
            })
            //Assign a readable number to the passages, starting from 1
            // we could use their passage id, but they're not guaranteed to be clean and sequential (idk how Twine manages them and I don't want to know)
            passages.forEach( (p,i,arr) => arr[i].number = (i+1));
            //Render the passages and join them into a single chunk of text
            let rendered = passages
            .map(p => renderPassage(p))
            .join("       "); //bunch of non-breakable spaces as separator

            let result = document.createElement("div");
            result.innerHTML = rendered;
            document.body.appendChild(result);
		</script>
	</body>
</html>
